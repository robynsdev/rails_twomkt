<div class="container mb-4">
  <div class="row">
    <div class="col-12 m-2 text-left">
      
      <h2>
        <%= @post.title %>
      </h2>

    </div>
  </div>
  <div class="row">
    <div class="col-8 text-left">

      <%= image_tag @post.picture, class: "show-img" if @post.picture.attached? %>

      <p>
        <span class="text-green text-lg">$<%= @post.price %></span>
        <span><%= @post.sales %></span>
      </p>

      <p>
        <i><%= @post.delivery.capitalize.gsub("_", " ") %></i>
      </p>

      <p>
        <strong>Description:</strong>
        <%= simple_format(@post.description) %>
      </p>
      
      <p>
        <strong>Categories:</strong>
        <% @post.category_ids.each_with_index do |cat_id, i| %>
          <% if i == @post.category_ids.length - 1 %>
            <%= @categories.find(cat_id).name %>
          <% else %>
            <%= @categories.find(cat_id).name %>, 
          <% end %>
        <% end %>
      </p>
    </div>
    <div class="col-4 text-left">
      <p> Contact <%= User.find(@post.user_id).name %> </p>
    </div>

  </div>
  <div class="border rounded-sm p-3">
    <div class="row">
      <div class="col-6 text-left">
        <p>
          <strong>Date Listed:</strong>
          <%= time_ago_in_words(@post.created_at) %> ago
        </p>
      </div>
      <div class="col-6 text-left">
        <p>
          <strong>Last Edited:</strong>
          <%= time_ago_in_words(@post.updated_at) %> ago
        </p>
      </div>
    </div>  
    <div class="row">
      <div class="col-12">
        <button id="checkout-button">Purchase</button>
        <br>
        <br>
        <% if can? :update, @post %>
          <%= link_to 'Edit', edit_post_path(@post) %> | 
        <% end %>
        <% if can? :destroy, @post %>
          <%= link_to 'Delete', post_path(@post), 
            method: :delete,
            data: { confirm: 'Are you sure?' } %> |       
        <% end %>
          <%= link_to 'Back', posts_path %>
      </div>
    </div>
  </div>
</div>

  <script type="text/javascript">
    // Create an instance of the Stripe object with your publishable API key
    var stripe = Stripe('pk_test_51HmY9NAmy86VZXiMVt1kAQaatkbJYzxIhQQf0XO0RHNAOphQBoXG8kIn3I0lYYn4srPnfelZvqMPfKR6HWSAx9SB00ZJwPqNcs');
    var checkoutButton = document.getElementById('checkout-button');

    checkoutButton.addEventListener('click', function() {
      // Create a new Checkout Session using the server-side endpoint you
      // created in step 3.
      fetch('/checkout', {
        method: 'POST',
      })
      .then(function(response) {
        return response.json();
      })
      .then(function(session) {
        return stripe.redirectToCheckout({ sessionId: session.id });
      })
      .then(function(result) {
        // If `redirectToCheckout` fails due to a browser or network
        // error, you should display the localized error message to your
        // customer using `error.message`.
        if (result.error) {
          alert(result.error.message);
        }
      })
      .catch(function(error) {
        console.error('Error:', error);
      });
    });
  </script>